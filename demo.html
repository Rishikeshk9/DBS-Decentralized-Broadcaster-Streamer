<html>
  <header name = "Access-Control-Allow-Origin" value = "*" ></header>

<head>
  <meta charset="UTF-8">
<meta name="description" content="De Centralised Beats">
<meta name="keywords" content="DBeats">
<meta name="author" content="DBeats Team">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">

<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">

<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-notify/0.2.0/css/bootstrap-notify.min.css" rel="stylesheet">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.5.9/lottie.js"></script>
<script src="https://unpkg.com/@lottiefiles/lottie-interactivity@latest/dist/lottie-interactivity.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/kursor/dist/kursor.css">
<script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/kursor@0.0.14/dist/kursor.js"></script>

   <style>
     #thefile {
         
        top: 100px;
        left: 10px; 
        z-index: 100;
      }

      #canvas {
        position: fixed; 
      bottom:0%;
      width:100%; 
        left: 0; 
        width: 100%;
        height: 20%;
        z-index: 100;
        
      }

      audio {
        position: fixed;
        left: 10px;
        bottom: 10px;
        width: calc(100% - 20px);
        z-index: 101;
      }
      #videoElement {
	width: 500px;
	height: 375px;
	background-color: #666;
}
video {
  filter: drop-shadow(0 0 0.75rem rgb(145, 145, 145));
  border-radius: 10px;
  max-width: 80%;
}
#pip  {
   position: absolute;
   top: 35%;
   left: 45%;
   border-radius: 50%;
    
}
#cameraDiv {
    display: none;
    border-radius: 10px;
}
   </style>
   <link href="styles/style.css" rel="stylesheet">

  </head>

  <body>

    <h1 class="text-center  mt-3  ">Trending Tracks</h1>
    <div id="demo" style="padding-bottom:50px; ">
    </div>

    <div class="container-fluid">
      <div class="row my-5 text-center" style="z-index: 111111;">
 
        <div class="col-md-8">
          <button class="btn btn-primary" id="connect">Connect Server</button>&nbsp;
          <button class="btn btn-primary" id="start">Start Capture</button>&nbsp;
          <button class="btn btn-primary" id="stop">Stop Capture</button></p>
          <button class="btn btn-primary" id="streamCam">Start Webcam</button></p>

          <video id="video" autoplay></video>
      
          
          <pre id="log"></pre>
        </div>
        <div class="col-md-4">
          <div class="cameraDiv my-3">
            <video  autoplay="true" id="videoElement"  >
  
            </video>
            <button class="btn btn-primary " id="pip"><i class="fas fa-compress-arrows-alt"></i></button>&nbsp;
  
          </div>
        </div>
      </div>
      
      <div style="height: 500px;">
  sadas
      </div>
    </div>
   
   

    <div id="content">
      
      <canvas id="canvas"></canvas>
      <audio id="audio" style="background: transparent;" controls crossorigin="anonymous" ></audio>
    </div>

   
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
<script type="text/javascript" src="scripts/bootstrap-notify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>

  <script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@biconomy/mexa@1/dist/mexa.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.5.9/lottie.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kursor@0.0.14/dist/kursor.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5/dat.gui.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js"></script>
 
<script src="script.js"></script>
<script src="scripts/animation.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js" type="text/javascript"></script> 
  <script>
//Webcam
var video = document.querySelector("#videoElement");
const button = document.querySelector('#pip');
const cameraDiv = document.querySelector('#cameraDiv');
const streamCam = document.getElementById("streamCam");

streamCam.addEventListener("click", function(evt) {
 streamFaceCam();
}, false);

function streamFaceCam()
{

  if (navigator.mediaDevices.getUserMedia) {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(function (stream) {
      video.srcObject = stream;
             video.addEventListener('enterpictureinpicture', onEnterPip, false);
             video.addEventListener("leavepictureinpicture", onExitPip, false);

    })
    .catch(function (err0r) {
      console.log("Something went wrong!");
    });
}
}


button.onclick = function()   {
  video.requestPictureInPicture();
}

function onExitPip() {
  console.log("Picture-in-Picture mode deactivated!");
  video.style.display = "block";
  cameraDiv.style.display = "block";
  button.style.display = "block";
}
function onEnterPip() {
  console.log("Picture-in-Picture mode activated!");

  video.style.display = "none";
  cameraDiv.style.display = "none";
  button.style.display = "none";
}
//ScreenStream
const logElem = document.getElementById("log");
const startElem = document.getElementById("start");
const stopElem = document.getElementById("stop");
const videoElem = document.getElementById("video");
const connectElem = document.getElementById("connect");

const gdmOptions = {
  video: {
    cursor: "always"
  },
  audio: {
    echoCancellation: true,
    noiseSuppression: true,
    sampleRate: 44100
  }
}
startElem.addEventListener("click", function(evt) {
  startCapture();
}, false);

stopElem.addEventListener("click", function(evt) {
  stopCapture();
}, false);

connectElem.addEventListener("click", function(evt) {
  requestMedia();
}, false);
async function startCapture() { 
  logElem.innerHTML = "";

  try {
    videoElem.srcObject = await navigator.mediaDevices.getDisplayMedia(gdmOptions);
    dumpOptionsInfo();
  } catch(err) {
    console.error("Error: " + err);
  }


   
}

var mediaRecorder;
 var socket ;
 var state ="stop"; 
 var t;
function requestMedia(){
	var constraints = { video: {
    cursor: "always"
  },
  audio: {
    echoCancellation: true,
    noiseSuppression: true,
    sampleRate: 44100
  }
	};
	navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
		//video_show(stream);//only show locally, not remotely
	  var url = "rtmp://127.0.0.1:1935";
    socket = io.connect("rtmp://127.0.0.1:1935");
    // //socket.on(url);
    socket.emit('config_rtmpDestination',url);
		socket.emit('start','start');
		mediaRecorder = new MediaRecorder(stream);
    if(stream)
    console.log(stream);

		mediaRecorder.start(0);

		mediaRecorder.onstop = function(e) {
			stream.stop();
				
		}
		//document.getElementById('button_start').disabled=false;　

		mediaRecorder.ondataavailable = function(e) {
		
		  socket.emit("binarystream",e.data);
		  state="start";
		  //chunks.push(e.data);
		}
	}).catch(function(err) {
		console.log('The following error occured: ' + err);
		show_output('Local getUserMedia ERROR:'+err);
		output_message.innerHTML="Local video source size is not soupport or No camera ?"+output_video.videoWidth+"x"+output_video.videoHeight;
		 state="stop";
		 button_start.disabled=true;
		button_server.disabled=false;
	});
}

function show_output(str){

console.log(str)
}

function stopCapture(evt) {
  let tracks = videoElem.srcObject.getTracks();

  tracks.forEach(track => track.stop());
  videoElem.srcObject = null;
}

function dumpOptionsInfo() {
  const videoTrack = videoElem.srcObject.getVideoTracks()[0];

  console.info("Track settings:");
  console.info(JSON.stringify(videoTrack.getSettings(), null, 2));
  console.info("Track constraints:");
  console.info(JSON.stringify(videoTrack.getConstraints(), null, 2));
}
// }
// function startCapture(gdmOptions) {
//  let captureStream = null;

//  return navigator.mediaDevices.getDisplayMedia(gdmOptions)
//     .catch(err => { console.error("Error:" + err); return null; });
// }

 
    var audio = document.getElementById('music-player');
        
    var source = document.getElementById('music-player-src');

    var title = document.getElementById('title');

    var artist = document.getElementById('artist');

    var artwork = document.getElementsByClassName('music-artwork');


       

function getJSON(url) {
            var resp ;
            var xmlHttp ;

            resp  = '' ;
            xmlHttp = new XMLHttpRequest();

            if(xmlHttp != null)
            {
                xmlHttp.open( "GET", url, false );
                xmlHttp.send( null );
                resp = xmlHttp.responseText;
            }

            return resp ;
        } 

var gjson ;
        gjson = getJSON('https://discoveryprovider.audius.co/v1/tracks/trending') ;

        var gjson2 = JSON.parse(gjson);

        for(var i =0;i<35;i++){
                var artwork = gjson2.data[i].artwork['150x150'];
                var description = gjson2.data[i].description;
                var duration = gjson2.data[i].duration;
                var id = gjson2.data[i].id;
                var title = gjson2.data[i].title;   
                var user = gjson2.data[i].user;     
                var username = gjson2.data[i].user.name;
                var userId = gjson2.data[i].user.id;
                var trackLayout = '<div class="card m-3 music-artwork rounded-circle" style="width: 150px;height:200px;outline: none;" data-artwork="'+artwork+'" data-artist="'+username+'" data-artistid="'+userId+'" name="'+title+'"   data-id="'+id+'" ><img class="rounded-circle"  style="height:100%;width:100%;" src="'+artwork+'" alt="Card image cap"><div class="card-body rounded-circle"   ><h5 class="card-title text-center text-dark">'+title+'</h5> </div></div>';
                $('#demo').append(trackLayout);
                //console.log(i);    

        }

    window.onload = function() {
  
  var file = document.getElementById("thefile");
  let firstFlag = true;
  let wm = new WeakMap();
  let context, analyser;
  let src; 
  $(".music-artwork").click(function() {
          if (src) {
              src.disconnect();
            }
          let audio = document.getElementById("audio");
            let sourceUrl = "https://discoveryprovider.audius.co/v1/tracks/"+$(this).attr("data-id")+"/stream";
            //let audio = document.getElementById('myAudio');   
            //alert(audio.src);
            // $("#music-player").attr("src", sourceUrl); 
            //$("#now-playing-artwork").attr("src", $(this).attr("data-artwork"));
            //let imageUrl = $(this).attr("data-artwork"); 
                 //$("body").css("background-image", "url(" + imageUrl + ")"); 
          
            audio.src = sourceUrl;

            audio.load();//suspends and restores all audio element
            audio.play();

            // title.innerHTML = $(this).attr('name');
            // artist.innerHTML =  $(this).attr("data-artist");
 
            // audio.oncanplaythrough = audio.play();
            // audio = new Audio(sourceUrl);
            if(firstFlag){
            // AudioContextの生成
            context = new (window.AudioContext || window.webkitAudioContext)();
            firstFlag = false;     
            }   
            // const stream_dest = context.createMediaStreamDestination();
            // let context = new AudioContext();
            if (wm.has(audio)) { 
              src = wm.get(audio); 
            } else { 
              src = context.createMediaElementSource(audio);
              // audioSourceNode = audioCtx.createMediaElementSource(audioEle); 
              wm.set(audio, src); 
            }  

    // let src = context.createMediaStreamSource(sourceUrl);
    if(analyser){
        analyser.disconnect();
      } 
    analyser = context.createAnalyser();

    let canvas = document.getElementById("canvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let ctx = canvas.getContext("2d");

    src.connect(analyser);
    
    analyser.connect(context.destination);

    analyser.fftSize = 256;

    let bufferLength = analyser.frequencyBinCount;
    console.log(bufferLength);

    let dataArray = new Uint8Array(bufferLength);

    let WIDTH = canvas.width;
    let HEIGHT = canvas.height;

    let barWidth = (WIDTH / bufferLength) * 2.5;
    let barHeight;
    let x = 0;

    function renderFrame() {
      requestAnimationFrame(renderFrame);

      x = 0;

      analyser.getByteFrequencyData(dataArray);

      ctx.fillStyle = "#FFF";
      ctx.fillRect(0, 0, WIDTH, HEIGHT);

      for (let i = 0; i < bufferLength; i++) {
        barHeight = dataArray[i]*2.8;
        
        let r = barHeight + (25 * (i/bufferLength));
        let g = 250 * (i/bufferLength);
        let b = 50;
        myImage = $('#myImage');
 
        //dominantColor = getDominantColor(myImage);

        ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
        ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

        x += barWidth + 1;
      }
    }

    renderFrame();
                 
        });
   
};

// window.onload = function() {
  
//   var file = document.getElementById("thefile");
//   var audio = document.getElementById("audio");
  
//   file.onchange = function() {
//     var files = this.files;
//     audio.src = URL.createObjectURL(files[0]);
//     audio.load();
//     audio.play();
//     var context = new AudioContext();
//     var src = context.createMediaElementSource(audio);
//     var analyser = context.createAnalyser();

//     var canvas = document.getElementById("canvas");
//     canvas.width = window.innerWidth;
//     canvas.height = window.innerHeight;
//     var ctx = canvas.getContext("2d");

//     src.connect(analyser);
//     analyser.connect(context.destination);

//     analyser.fftSize = 256;

//     var bufferLength = analyser.frequencyBinCount;
//     console.log(bufferLength);

//     var dataArray = new Uint8Array(bufferLength);

//     var WIDTH = canvas.width;
//     var HEIGHT = canvas.height;

//     var barWidth = (WIDTH / bufferLength) * 2.5;
//     var barHeight;
//     var x = 0;

//     function renderFrame() {
//       requestAnimationFrame(renderFrame);

//       x = 0;

//       analyser.getByteFrequencyData(dataArray);

//       ctx.fillStyle = "#000";
//       ctx.fillRect(0, 0, WIDTH, HEIGHT);

//       for (var i = 0; i < bufferLength; i++) {
//         barHeight = dataArray[i];
        
//         var r = barHeight + (25 * (i/bufferLength));
//         var g = 250 * (i/bufferLength);
//         var b = 50;

//         ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
//         ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

//         x += barWidth + 1;
//       }
//     }

//     audio.play();
//     renderFrame();
//   };
// };
  </script>
</html>